"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5698],{11470:(e,n,t)=>{t.d(n,{A:()=>v});var r=t(96540),i=t(34164),s=t(23104),a=t(56347),o=t(205),l=t(57485),d=t(31682),p=t(70679);function c(e){return r.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function u(e){const{values:n,children:t}=e;return(0,r.useMemo)(()=>{const e=n??function(e){return c(e).map(({props:{value:e,label:n,attributes:t,default:r}})=>({value:e,label:n,attributes:t,default:r}))}(t);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,t])}function m({value:e,tabValues:n}){return n.some(n=>n.value===e)}function h({queryString:e=!1,groupId:n}){const t=(0,a.W6)(),i=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(i),(0,r.useCallback)(e=>{if(!i)return;const n=new URLSearchParams(t.location.search);n.set(i,e),t.replace({...t.location,search:n.toString()})},[i,t])]}function g(e){const{defaultValue:n,queryString:t=!1,groupId:i}=e,s=u(e),[a,l]=(0,r.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const t=n.find(e=>e.default)??n[0];if(!t)throw new Error("Unexpected error: 0 tabValues");return t.value}({defaultValue:n,tabValues:s})),[d,c]=h({queryString:t,groupId:i}),[g,_]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[t,i]=(0,p.Dv)(n);return[t,(0,r.useCallback)(e=>{n&&i.set(e)},[n,i])]}({groupId:i}),f=(()=>{const e=d??g;return m({value:e,tabValues:s})?e:null})();(0,o.A)(()=>{f&&l(f)},[f]);return{selectedValue:a,selectValue:(0,r.useCallback)(e=>{if(!m({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);l(e),c(e),_(e)},[c,_,s]),tabValues:s}}var _=t(92303);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(74848);function b({className:e,block:n,selectedValue:t,selectValue:r,tabValues:a}){const o=[],{blockElementScrollPositionUntilNextRender:l}=(0,s.a_)(),d=e=>{const n=e.currentTarget,i=o.indexOf(n),s=a[i].value;s!==t&&(l(n),r(s))},p=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{const t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},e),children:a.map(({value:e,label:n,attributes:r})=>(0,x.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{o.push(e)},onKeyDown:p,onClick:d,...r,className:(0,i.A)("tabs__item",f.tabItem,r?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function j({lazy:e,children:n,selectedValue:t}){const s=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=s.find(e=>e.props.value===t);return e?(0,r.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:s.map((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function y(e){const n=g(e);return(0,x.jsxs)("div",{className:(0,i.A)("tabs-container",f.tabList),children:[(0,x.jsx)(b,{...n,...e}),(0,x.jsx)(j,{...n,...e})]})}function v(e){const n=(0,_.A)();return(0,x.jsx)(y,{...e,children:c(e.children)},String(n))}},19365:(e,n,t)=>{t.d(n,{A:()=>a});t(96540);var r=t(34164);const i={tabItem:"tabItem_Ymn6"};var s=t(74848);function a({children:e,hidden:n,className:t}){return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.A)(i.tabItem,t),hidden:n,children:e})}},23662:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/IC-LiteRT-NPU-b2d61dda8093207893370e151a3f9838.jpeg"},26773:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/Image-Classification-LiteRT-6d8779ca8e637f6c8be14d9611346fc4.png"},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(96540);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}},34275:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/OpenCV-OD-66beef4f3ce80e7fddf5a740b7706421.png"},48865:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/IC-LiteRT-CPU-3322117a486c0011fb31f476f3242ef2.jpeg"},54623:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>d,default:()=>m,frontMatter:()=>l,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"Document Home/Application Development and Execution Guide/Framework-Driven AI Sample Execution/litert_tflite","title":"LiteRT / TFLite","description":"LiteRT, formerly known as TensorFlow Lite, is Google\'s high-performance runtime for on-device AI. You can run existing quantized LiteRT models (in Python or C++) on the NPU on Dragonwing devices with a single line of code using the LiteRT delegates that are part of AI Engine Direct.","source":"@site/docs/Document Home/5.Application Development and Execution Guide/2.Framework-Driven AI Sample Execution/3.litert_tflite.md","sourceDirName":"Document Home/5.Application Development and Execution Guide/2.Framework-Driven AI Sample Execution","slug":"/Document Home/Application Development and Execution Guide/Framework-Driven AI Sample Execution/litert_tflite","permalink":"/rubikpi-ubuntu-user-manual-test-en.github.io/docs/Document Home/Application Development and Execution Guide/Framework-Driven AI Sample Execution/litert_tflite","draft":false,"unlisted":false,"editUrl":"https://github.com/hongyang-rp/rubikpi-ubuntu-user-manual-test-en.github.io/tree/main/docs/Document Home/5.Application Development and Execution Guide/2.Framework-Driven AI Sample Execution/3.litert_tflite.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Qualcomm\xae AI Hub","permalink":"/rubikpi-ubuntu-user-manual-test-en.github.io/docs/Document Home/Application Development and Execution Guide/Building AI Models/qualcomm_ai_hub"},"next":{"title":"ONNX","permalink":"/rubikpi-ubuntu-user-manual-test-en.github.io/docs/Document Home/Application Development and Execution Guide/Framework-Driven AI Sample Execution/onnx"}}');var i=t(74848),s=t(28453),a=t(11470),o=t(19365);const l={},d="LiteRT / TFLite",p={},c=[{value:"Quantizing models",id:"quantizing-models",level:2},{value:"Running a model on the NPU (Python)",id:"running-a-model-on-the-npu-python",level:2},{value:"Running a model on the NPU (C++)",id:"running-a-model-on-the-npu-c",level:2},{value:"Python Examples",id:"python-examples",level:3},{value:"Vision Transformers",id:"vision-transformers",level:3},{value:"GTK-Based Image Classification App",id:"gtk-based-image-classification-app",level:3},{value:"Helper Functions",id:"helper-functions",level:3},{value:"Reference Code",id:"reference-code",level:3},{value:"Object Detection with OpenCV &amp; Wayland Display",id:"object-detection-with-opencv--wayland-display",level:3},{value:"Reference Code",id:"reference-code-1",level:3}];function u(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"litert--tflite",children:"LiteRT / TFLite"})}),"\n",(0,i.jsx)(n.p,{children:"LiteRT, formerly known as TensorFlow Lite, is Google's high-performance runtime for on-device AI. You can run existing quantized LiteRT models (in Python or C++) on the NPU on Dragonwing devices with a single line of code using the LiteRT delegates that are part of AI Engine Direct."}),"\n",(0,i.jsx)(n.h2,{id:"quantizing-models",children:"Quantizing models"}),"\n",(0,i.jsxs)(n.p,{children:["The NPU only supports uint8/int8 quantized models. Unsupported models, or unsupported layers will be automatically moved back to the CPU. You can use ",(0,i.jsx)(n.a,{href:"https://www.tensorflow.org/model_optimization/guide/quantization/training_comprehensive_guide",children:"quantization-aware training"})," or ",(0,i.jsx)(n.a,{href:"https://ai.google.dev/edge/litert/models/post_training_quantization",children:"post-training quantization"}),' to quantize your LiteRT models. Make sure you follow the steps for "Full integer quantization".']}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Don't want to quantize yourself?"})," You can download a range of pre-quantized models from ",(0,i.jsx)(n.a,{href:"https://aihub.qualcomm.com",children:"Qualcomm AI Hub"}),", or use ",(0,i.jsx)(n.a,{href:"https://qc-ai-test.gitbook.io/qc-ai-test-docs/running-building-ai-models/edge-impulse",children:"Edge Impulse"})," to quantize new or existing models."]})}),"\n",(0,i.jsx)(n.h2,{id:"running-a-model-on-the-npu-python",children:"Running a model on the NPU (Python)"}),"\n",(0,i.jsx)(n.p,{children:"To offload a model to the NPU, you just need to load the LiteRT delegate; and pass it into the interpreter. E.g.:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:'from ai_edge_litert.interpreter import Interpreter, load_delegate\r\n\r\nqnn_delegate = load_delegate("libQnnTFLiteDelegate.so", options={"backend_type": "htp"})\r\ninterpreter = Interpreter(\r\n    model_path=...,\r\n    experimental_delegates=[qnn_delegate]\r\n)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"running-a-model-on-the-npu-c",children:"Running a model on the NPU (C++)"}),"\n",(0,i.jsx)(n.p,{children:"To offload a model to the NPU, you'll first need to add the following compile flags:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-makefile",children:"CFLAGS += -I${QNN_SDK_ROOT}/include\r\nLDFLAGS += -L${QNN_SDK_ROOT}/lib/aarch64-ubuntu-gcc9.4 -lQnnTFLiteDelegate\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then, you instantiate the LiteRT delegate and pass it to the LiteRT interpreter:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-c",children:'// == Includes ==\r\n#include "QNN/TFLiteDelegate/QnnTFLiteDelegate.h"\r\n\r\n// == Application code ==\r\n\r\n// Get your interpreter...\r\ntflite::Interpreter *interpreter = ...;\r\n\r\n// Create QNN Delegate options structure.\r\nTfLiteQnnDelegateOptions options = TfLiteQnnDelegateOptionsDefault();\r\n\r\n// Set the mandatory backend_type option. All other options have default values.\r\noptions.backend_type = kHtpBackend;\r\n\r\n// Instantiate delegate. Must not be freed until interpreter is freed.\r\nTfLiteDelegate* delegate = TfLiteQnnDelegateCreate(&options);\r\n\r\nTfLiteStatus status = interpreter->ModifyGraphWithDelegate(delegate);\r\n// Check that status == kTfLiteOk\n'})}),"\n",(0,i.jsx)(n.h3,{id:"python-examples",children:"Python Examples"}),"\n",(0,i.jsxs)(a.A,{children:[(0,i.jsxs)(o.A,{value:"Example1",label:"Vision Transformers",children:[(0,i.jsx)(n.h3,{id:"vision-transformers",children:"Vision Transformers"}),(0,i.jsxs)(n.p,{children:["Here's how you can run a Vision Transformer model (downloaded from ",(0,i.jsx)(n.a,{href:"https://aihub.qualcomm.com/models/vit",children:"AI Hub"}),") on both the CPU and the NPU using the LiteRT delegates."]}),(0,i.jsx)(n.p,{children:"Open the terminal on your development board, or an ssh session to your development board, and:"}),(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create a new venv, and install the LiteRT runtime and Pillow:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"mkdir -p litert-demo/\r\ncd litert-demo/\r\n\r\npython3 -m venv .venv\r\nsource .venv/bin/activate\r\npip3 install ai-edge-litert==1.3.0 Pillow\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Create ",(0,i.jsx)(n.code,{children:"inference_vit.py"})," and add:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-py",children:'import numpy as np\r\nfrom ai_edge_litert.interpreter import Interpreter, load_delegate\r\nfrom PIL import Image\r\nimport os, time, sys\r\nimport urllib.request\r\n\r\ndef curr_ms():\r\n    return round(time.time() * 1000)\r\n\r\nuse_npu = True if len(sys.argv) >= 2 and sys.argv[1] == \'--use-npu\' else False\r\n\r\n# Path to your quantized TFLite model and test image (will be download automatically)\r\nMODEL_PATH = "vit-vit-w8a8.tflite"\r\nIMAGE_PATH = "boa-constrictor.jpg"\r\nLABELS_PATH = "vit-vit-labels.txt"\r\n\r\nif not os.path.exists(MODEL_PATH):\r\n    print("Downloading model...")\r\n    model_url = \'https://cdn.edgeimpulse.com/qc-ai-docs/models/vit-vit-w8a8.tflite\'\r\n    urllib.request.urlretrieve(model_url, MODEL_PATH)\r\n\r\nif not os.path.exists(LABELS_PATH):\r\n    print("Downloading labels...")\r\n    labels_url = \'https://cdn.edgeimpulse.com/qc-ai-docs/models/vit-vit-labels.txt\'\r\n    urllib.request.urlretrieve(labels_url, LABELS_PATH)\r\n\r\nif not os.path.exists(IMAGE_PATH):\r\n    print("Downloading image...")\r\n    image_url = \'https://cdn.edgeimpulse.com/qc-ai-docs/examples/boa-constrictor.jpg\'\r\n    urllib.request.urlretrieve(image_url, IMAGE_PATH)\r\n\r\nwith open(LABELS_PATH, \'r\') as f:\r\n    labels = [line for line in f.read().splitlines() if line.strip()]\r\n\r\nexperimental_delegates = []\r\nif use_npu:\r\n    experimental_delegates = [load_delegate("libQnnTFLiteDelegate.so", options={"backend_type": "htp"})]\r\n\r\n# Load TFLite model and allocate tensors\r\ninterpreter = Interpreter(\r\n    model_path=MODEL_PATH,\r\n    experimental_delegates=experimental_delegates\r\n)\r\ninterpreter.allocate_tensors()\r\n\r\n# Get input and output tensor details\r\ninput_details = interpreter.get_input_details()\r\noutput_details = interpreter.get_output_details()\r\n\r\n# Load and preprocess image\r\ndef load_image(path, input_shape):\r\n    # Expected input shape: [1, height, width, channels]\r\n    _, height, width, channels = input_shape\r\n\r\n    img = Image.open(path).convert("RGB").resize((width, height))\r\n    img_np = np.array(img, dtype=np.uint8)  # quantized models expect uint8\r\n    img_np = np.expand_dims(img_np, axis=0)\r\n    return img_np\r\n\r\ninput_shape = input_details[0][\'shape\']\r\ninput_data = load_image(IMAGE_PATH, input_shape)\r\n\r\n# Set tensor and run inference\r\ninterpreter.set_tensor(input_details[0][\'index\'], input_data)\r\n\r\n# Run once to warmup\r\ninterpreter.invoke()\r\n\r\n# Then run 10x\r\nstart = curr_ms()\r\nfor i in range(0, 10):\r\n    interpreter.invoke()\r\nend = curr_ms()\r\n\r\n# Get prediction\r\nq_output = interpreter.get_tensor(output_details[0][\'index\'])\r\nscale, zero_point = output_details[0][\'quantization\']\r\nf_output = (q_output.astype(np.float32) - zero_point) * scale\r\n\r\n# Image classification models in AI Hub miss a Softmax() layer at the end of the model, so add it manually\r\ndef softmax(x, axis=-1):\r\n    # subtract max for numerical stability\r\n    x_max = np.max(x, axis=axis, keepdims=True)\r\n    e_x = np.exp(x - x_max)\r\n    return e_x / np.sum(e_x, axis=axis, keepdims=True)\r\n\r\n# show top-5 predictions\r\nscores = softmax(f_output[0])\r\ntop_k = scores.argsort()[-5:][::-1]\r\nprint("\\nTop-5 predictions:")\r\nfor i in top_k:\r\n    print(f"Class {labels[i]}: score={scores[i]}")\r\n\r\nprint(\'\')\r\nprint(f\'Inference took (on average): {(end - start) / 10}ms. per image\')\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Run the model on the CPU:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"python3 inference_vit.py\r\n\r\n# INFO: Created TensorFlow Lite XNNPACK delegate for CPU.\r\n#\r\n# Top-5 predictions:\r\n# Class boa constrictor: score=0.6264431476593018\r\n# Class rock python: score=0.047579940408468246\r\n# Class night snake: score=0.006721484009176493\r\n# Class mouse: score=0.0022421202156692743\r\n# Class pick: score=0.001942973816767335\r\n#\r\n# Inference took (on average): 391.1ms. per image\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Run the model on the NPU:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"python3 inference_vit.py --use-npu\r\n\r\n# INFO: TfLiteQnnDelegate delegate: 1382 nodes delegated out of 1633 nodes with 27 partitions.\r\n#\r\n# INFO: Created TensorFlow Lite XNNPACK delegate for CPU.\r\n#\r\n# Top-5 predictions:\r\n# Class boa constrictor: score=0.6113042235374451\r\n# Class rock python: score=0.038359832018613815\r\n# Class night snake: score=0.011630792170763016\r\n# Class mouse: score=0.002294909441843629\r\n# Class lens cap: score=0.0018960189772769809\r\n#\r\n# Inference took (on average): 132.7ms. per image\n"})}),"\n"]}),"\n"]}),(0,i.jsx)(n.p,{children:'As you can see this model runs significantly faster on NPU - but there\'s a slight change in the output of the model. You can also see that for this model not all layers can run on NPU ("1382 nodes delegated out of 1633 nodes with 27 partitions").'})]}),(0,i.jsxs)(o.A,{value:"Example2",label:"Image Classification",children:[(0,i.jsx)(n.h3,{id:"gtk-based-image-classification-app",children:"GTK-Based Image Classification App"}),(0,i.jsxs)(n.p,{children:["Here's how you can use a GTK-based desktop application to run an image classification model\u2014downloaded from ",(0,i.jsx)(n.a,{href:"https://aihub.qualcomm.com/iot/models/googlenet?searchTerm=google&chipsets=qualcomm-qcs6490-proxy",children:"(AI Hub)"})," on both the CPU and NPU using LiteRT delegates from AI Engine Direct."]}),(0,i.jsx)(n.p,{children:"The model uses TensorFlow Lite with QNN delegate acceleration for efficient on-device inference."}),(0,i.jsxs)(n.p,{children:["Since this model isn\u2019t available on Edge Impulse, download it with precision ",(0,i.jsx)(n.code,{children:"w8a8"})," and set the runtime to ",(0,i.jsx)(n.code,{children:"TFLite"}),"."]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.img,{src:t(26773).A+"",width:"1330",height:"721"}),"\r\nThe next step is to push the model on to the target device",(0,i.jsx)(n.br,{}),"\n","Through scp command copy the model and image onto the device."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"scp xxxx.tflite ubuntu@IP_address:/home/ubuntu/\r\nscp xxx.jpg ubuntu@IP_address:/home/ubuntu/\n"})}),(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"Download any image from internet. In this example we used firetruck image."})}),(0,i.jsx)(n.p,{children:"Open the terminal on your development board, or an ssh session to your development board, and:"}),(0,i.jsx)(n.p,{children:"Create a new venv, and install the LiteRT runtime and Pillow:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"python3 -m venv .venv-litert-demo\r\nsource .venv-litert-demo/bin/activate\r\npip3 install ai-edge-litert==1.3.0 Pillow\r\npip3 install opencv-python\r\nsudo apt install python3-gi python3-gi-cairo gir1.2-gtk-3.0\r\nsudo apt install python3-venv python3-full\r\nsudo apt install -y pkg-config cmake libcairo2-dev\r\nsudo apt install libgirepository1.0-dev gir1.2-glib-2.0\r\nsudo apt install build-essential python3-dev python3-pip pkg-config meson\n"})}),(0,i.jsxs)(n.p,{children:["Now follow the steps to create Image classification application.",(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.strong,{children:"Summary"}),(0,i.jsx)(n.br,{}),"\n","\u2022  Type: Desktop GUI application",(0,i.jsx)(n.br,{}),"\n","\u2022  Functionality: Image classification using TFLite",(0,i.jsx)(n.br,{}),"\n","\u2022  Modes: CPU and QNN delegate",(0,i.jsx)(n.br,{}),"\n","\u2022  Interface: GTK-based GUI",(0,i.jsx)(n.br,{}),"\n","\u2022  Output: Top predictions with confidence bars"]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Environment Setup & Imports"}),(0,i.jsx)(n.br,{}),"\n","In the step the script sets up display-related environment variables (for Linux systems) and imports necessary libraries like OpenCV, NumPy, GTK, and TensorFlow Lite."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"import cv2, numpy as np, os, time\r\nfrom gi.repository import Gtk, GLib, GdkPixbuf\r\nimport ai_edge_litert.interpreter as tflite\n"})}),(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsx)(n.p,{children:"\u2022\tGTK is used for the GUI, OpenCV for image handling, and TensorFlow Lite for inference."})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Configuration Constants"}),(0,i.jsx)(n.br,{}),"\n","These constants define paths to the model, label file, and delegate library."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'TF_MODEL = "googlenet-googlenet-w8a8.tflite"\r\nLABELS = "imagenet_labels.txt"\r\nDELEGATE_PATH = "libQnnTFLiteDelegate.so"\r\nDEVICE_OS = "Ubuntu"\n'})}),(0,i.jsx)(n.h3,{id:"helper-functions",children:"Helper Functions"}),(0,i.jsx)(n.p,{children:"This step sets up the core logic and interface for image classification using LiteRT and GTK."}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Softmax Calculation"}),(0,i.jsx)(n.br,{}),"\n","Ensures numerical stability when converting logits to probabilities."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"Pythondef stable_softmax(logits):    \r\nlogits = logits.astype(np.float32)    \r\nshifted_logits = np.clip(logits - np.max(logits), -500, 500)    \r\nexp_scores = np.exp(shifted_logits)    \r\nreturn exp_scores / np.sum(exp_scores)\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Label Loader"}),(0,i.jsx)(n.br,{}),"\n","Loads class labels from a text file."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"Pythondef load_labels(label_path):    \r\nwith open(label_path, 'r') as f: \r\n       return [line.strip() for line in f.readlines()]\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Image Preprocessing"}),(0,i.jsx)(n.br,{}),"\n","Prepares the image for model input: resizing, color conversion, and reshaping."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"Pythondef preprocess_image(image_path, input_shape, input_dtype):   \r\nimg = cv2.imread(image_path)    \r\nimg = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)    \r\nimg = cv2.resize(img, (input_shape[2], input_shape[1]))    \r\nimg = img.astype(input_dtype)    \r\nreturn np.expand_dims(img, axis=0)\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Inference Execution"}),(0,i.jsx)(n.br,{}),"\n","This function will:",(0,i.jsx)(n.br,{}),"\n","\u2022\tLoads the model (with or without delegate)",(0,i.jsx)(n.br,{}),"\n","\u2022\tPrepares input",(0,i.jsx)(n.br,{}),"\n","\u2022\tRuns inference",(0,i.jsx)(n.br,{}),"\n","\u2022\tApplies softmax",(0,i.jsx)(n.br,{}),"\n","\u2022\tReturns top 4 predictions with confidence scores"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"def runInference(image, use_delegate):\r\n    if use_delegate:\r\n        try:\r\n            delegate = tflite.load_delegate(DELEGATE_PATH, {'backend_type': 'htp'})\r\n            model = tflite.Interpreter(model_path=TF_MODEL, experimental_delegates=[delegate])\r\n        except:\r\n            model = tflite.Interpreter(model_path=TF_MODEL)\r\n    else:\r\n        model = tflite.Interpreter(model_path=TF_MODEL)\r\n    model.allocate_tensors()\r\n    input_details = model.get_input_details()\r\n    input_data = preprocess_image(image, input_details[0]['shape'], input_details[0]['dtype'])\r\n    model.set_tensor(input_details[0]['index'], input_data)\r\n    start_time = time.time()\r\n    model.invoke()\r\n    inference_time = time.time() - start_time\r\n    output_data = model.get_tensor(model.get_output_details()[0]['index'])\r\n    probabilities = stable_softmax(output_data[0])\r\n    labels = load_labels(LABELS)\r\n    top_indices = np.argsort(probabilities)[::-1][:4]\r\n    results = [(labels[i], probabilities[i] * 100) for i in top_indices]\r\n    return results, inference_time\n"})}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"GTK GUI Components"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"File Browser Dialog"}),(0,i.jsx)(n.br,{}),"\n","Allows users to select an image file."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class FileBrowser(Gtk.FileChooserDialog):\r\n    def __init__(self):\r\n        super().__init__(title="Choose an image", action=Gtk.FileChooserAction.OPEN)\r\n        self.add_buttons(Gtk.STOCK_CANCEL, Gtk.ResponseType.CANCEL, Gtk.STOCK_OPEN, Gtk.ResponseType.OK)\r\n    def run_and_get_file(self):\r\n        if self.run() == Gtk.ResponseType.OK:\r\n            return self.get_filename()\r\n        self.destroy()\n'})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Main Window"}),(0,i.jsx)(n.br,{}),"\n","The GUI includes:",(0,i.jsx)(n.br,{}),"\n","\u2022\tImage display area",(0,i.jsx)(n.br,{}),"\n","\u2022\tRadio buttons to choose CPU or delegate",(0,i.jsx)(n.br,{}),"\n","\u2022\tButtons to select and reprocess image",(0,i.jsx)(n.br,{}),"\n","\u2022\tResult display with labels and progress bars"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class MainWindow(Gtk.Window):\r\n    def __init__(self):\r\n        super().__init__(title="Image Classification")\r\n        self.set_default_size(800, 600)\r\n        self.imageFilepath = ""\r\n        ...\n'})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Image Processing and Display"}),(0,i.jsx)(n.br,{}),"\n","This method:",(0,i.jsx)(n.br,{}),"\n","\u2022\tResizes and displays the image",(0,i.jsx)(n.br,{}),"\n","\u2022\tRuns inference",(0,i.jsx)(n.br,{}),"\n","\u2022\tDisplays results with progress bars and inference time"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"def process_file(self, filepath):\r\n    pixbuf = GdkPixbuf.Pixbuf.new_from_file(filepath)\r\n    new_width, new_height = resizeImage(pixbuf)\r\n    scaled_pixbuf = pixbuf.scale_simple(new_width, new_height, GdkPixbuf.InterpType.BILINEAR)\r\n    self.image.set_from_pixbuf(scaled_pixbuf)\r\n\r\n    results, inference_time = runInference(filepath, self.use_delegate())\r\n    ...\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Application Entry Point"}),(0,i.jsx)(n.br,{}),"\n","Initializes and launches the GTK application."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'def main():\r\n    app = MainWindow()\r\n    app.connect("destroy", Gtk.main_quit)\r\n    app.show_all()\r\n    Gtk.main()\r\nif __name__ == "__main__":\r\n    success, _ = Gtk.init_check()\r\n    if not success:\r\n        print("GTK could not be initialized.")\r\n        exit(1)\r\n    main()\n'})}),(0,i.jsx)(n.h3,{id:"reference-code",children:"Reference Code"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# -----------------------------------------------------------------------------\r\n#\r\n# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.\r\n# SPDX-License-Identifier: BSD-3-Clause\r\n#\r\n# -----------------------------------------------------------------------------\r\n\r\nimport cv2\r\nimport gi\r\nimport numpy as np\r\nimport os\r\nos.environ[\'xDG_RUNTIME_DIR\'] = \'/run/user/1000/\'\r\nos.environ[\'WAYLAND_DISPLAY\'] = \'wayland-1\'\r\nos.environ[\'DISPLAY\'] = \':0\'\r\nimport time\r\ngi.require_version("Gtk", "3.0")\r\nfrom gi.repository import Gtk, GLib, GdkPixbuf\r\n\r\n# ========= Constants =========\r\nTF_MODEL = "googlenet-googlenet-w8a8.tflite"\r\nLABELS = "/etc/labels/imagenet_labels.txt"\r\nDELEGATE_PATH = "libQnnTFLiteDelegate.so"\r\nDEVICE_OS="Ubuntu"\r\nUNAME = os.uname().nodename\r\n\r\nimport ai_edge_litert.interpreter as tflite\r\n\r\n# ========= Helper Functions =========\r\ndef stable_softmax(logits):\r\n    # Convert logits to float64 for higher precision\r\n    logits = logits.astype(np.float32)\r\n    \r\n    # Subtract the maximum logit to prevent overflow\r\n    shifted_logits = logits - np.max(logits)\r\n    \r\n    # Clip the shifted logits to a safe range to prevent overflow in exp\r\n    shifted_logits = np.clip(shifted_logits, -500, 500)\r\n    \r\n    # Calculate the exponentials and normalize\r\n    exp_scores = np.exp(shifted_logits)\r\n    probabilities = exp_scores / np.sum(exp_scores)\r\n    \r\n    return probabilities\r\n\r\n# Load labels from file\r\ndef load_labels(label_path):\r\n    with open(label_path, \'r\') as f:\r\n        return [line.strip() for line in f.readlines()]\r\n\r\ndef resizeImage(pixbuf):\r\n    original_width = pixbuf.get_width()\r\n    original_height = pixbuf.get_height()\r\n\r\n    # Target display size\r\n    max_width = 800\r\n    max_height = 600\r\n\r\n    # Calculate new size preserving aspect ratio\r\n    scale = min(max_width / original_width, max_height / original_height)\r\n    new_width = int(original_width * scale)\r\n    new_height = int(original_height * scale)\r\n\r\n    return new_width, new_height\r\n\r\n# Load and preprocess input image\r\ndef preprocess_image(image_path, input_shape, input_dtype):\r\n    # Read the image using OpenCV\r\n    img = cv2.imread(image_path)\r\n    if img is None:\r\n        raise ValueError(f"Failed to load image at {image_path}")\r\n    # Convert BGR to RGB\r\n    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)\r\n    # Resize the image to the desired input shape\r\n    img = cv2.resize(img, (input_shape[2], input_shape[1]))\r\n    # Convert to the desired data type\r\n    img = img.astype(input_dtype)\r\n    # Add batch dimension\r\n    img = np.expand_dims(img, axis=0)\r\n    \r\n    return img\r\n\r\n# ====== Inference Function ======\r\ndef runInference(image, use_delegate):\r\n    results = []    \r\n    print(f"Running on {DEVICE_OS} using Delegate:{use_delegate}")\r\n    if use_delegate:\r\n        try:\r\n            # Load the QNN delegate library\r\n            delegate_options = { \'backend_type\': \'htp\' }\r\n            delegate = tflite.load_delegate(DELEGATE_PATH, delegate_options)\r\n            \r\n            # Load the TFLite model\r\n            model = tflite.Interpreter(model_path=TF_MODEL, experimental_delegates=[delegate])\r\n            print("INFO: Loaded QNN delegate with HTP backend")\r\n        except Exception as e:\r\n            print(f"WARNING: Failed to load QNN delegate: {e}")\r\n            print("INFO: Continuing without QNN delegate")\r\n            model = tflite.Interpreter(model_path=TF_MODEL)   \r\n    else:\r\n        model = tflite.Interpreter(model_path=TF_MODEL)  \r\n   \r\n    model.allocate_tensors()\r\n\r\n    # Get and Prepare input \r\n    input_details = model.get_input_details()\r\n    input_shape = input_details[0][\'shape\']\r\n    input_dtype = input_details[0][\'dtype\']\r\n    input_data = preprocess_image(image, input_shape, input_dtype)\r\n    \r\n    # Load input data to input tensor\r\n    model.set_tensor(input_details[0][\'index\'], input_data)\r\n    model.get_signature_list()\r\n    \r\n    # Run inference\r\n    try:\r\n        start_time = time.time()\r\n        model.invoke()\r\n        end_time = time.time()\r\n        print("Interpreter invoked successfully.")\r\n    except Exception as e:\r\n        print(f"Error during model invocation: {e}")\r\n        return []\r\n\r\n    # Calculate and print duration\r\n    inference_time = end_time - start_time\r\n\r\n    # Prepare output tensor details\r\n    output_details = model.get_output_details()\r\n\r\n    # Load output data to output tensor\r\n    output_data = model.get_tensor(output_details[0][\'index\'])\r\n\r\n    # Load labels and get prediction\r\n    labels = load_labels(LABELS)\r\n    predicted_index = np.argmax(output_data)\r\n    predicted_label = labels[predicted_index]\r\n    print("Predicted index:", predicted_index)\r\n    print("Predicted label:", predicted_label)\r\n    \r\n    # Add Softmax function\r\n    logits = output_data[0]\r\n    probabilities = stable_softmax(logits)\r\n\r\n    # Get top 4 predictions\r\n    top_k = 4\r\n    top_indices = np.argsort(probabilities)[::-1][:top_k]\r\n    for i in top_indices:\r\n        result = (labels[i], probabilities[i] * 100)\r\n        results.append(result)\r\n\r\n    return results, inference_time\r\n\r\n# ====== GTK GUI Classes ======\r\nclass FileBrowser(Gtk.FileChooserDialog):\r\n    def __init__(self):\r\n        super().__init__(title="Choose an image", action=Gtk.FileChooserAction.OPEN)\r\n        self.add_buttons(Gtk.STOCK_CANCEL, Gtk.ResponseType.CANCEL, Gtk.STOCK_OPEN, Gtk.ResponseType.OK)\r\n\r\n    def run_and_get_file(self):\r\n        response = super().run()\r\n        if response == Gtk.ResponseType.OK:\r\n            print("Selected file:", self.get_filename())\r\n            self.selected_file = self.get_filename()            \r\n        self.destroy()\r\n        return self.selected_file\r\n\r\nclass MainWindow(Gtk.Window):\r\n    def __init__(self):\r\n        super().__init__(title="Image Classification")\r\n        self.set_default_size(800, 600)\r\n        self.imageFilepath = ""\r\n        # Main layout\r\n        self.mainBox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)\r\n        self.mainBox.set_margin_top(10)\r\n        self.mainBox.set_margin_bottom(10)\r\n        self.mainBox.set_margin_start(10)\r\n        self.mainBox.set_margin_end(10)\r\n        self.add(self.mainBox)\r\n        \r\n        # Main Window Image setup with fallback\r\n        self.image = Gtk.Image()\r\n        try:\r\n            MAIN_IMAGE = "MainWindowPic.jpg"\r\n            self.image.set_from_file(MAIN_IMAGE)         \r\n        except Exception as e:\r\n            print("Error loading main image:", e)\r\n            self.image.set_from_icon_name("image-missing", Gtk.IconSize.DIALOG)\r\n\r\n        self.mainBox.pack_start(self.image, True, True, 0)\r\n\r\n        # Set up a new box to add results and and file button\r\n        self.infoBox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)\r\n        \r\n        # Radio button to select Delegate\r\n        delegate_label = Gtk.Label(label="Select Inference Mode:")\r\n        self.infoBox.pack_start(delegate_label, False, False, 10)\r\n\r\n        self.cpu_radio = Gtk.RadioButton.new_with_label_from_widget(None, "CPU")\r\n        self.delegate_radio = Gtk.RadioButton.new_with_label_from_widget(self.cpu_radio, "Delegate")\r\n\r\n        self.infoBox.pack_start(self.cpu_radio, False, False, 0)\r\n        self.infoBox.pack_start(self.delegate_radio, False, False, 0)\r\n        \r\n        # Radio button signal\r\n        self.cpu_radio.connect("toggled", self.on_radio_toggled)\r\n        self.delegate_radio.connect("toggled", self.on_radio_toggled)\r\n\r\n        # Open file button\r\n        open_button = Gtk.Button(label="Select Image")\r\n        open_button.connect("clicked", self.on_open_file_clicked)\r\n        self.infoBox.pack_start(open_button, False, True, 10)\r\n\r\n        # Reprocess Image\r\n        reprocess_button = Gtk.Button(label="Reprocess Image")\r\n        reprocess_button.connect("clicked", self.on_reprocess_image_clicked)\r\n        self.infoBox.pack_start(reprocess_button, False, True, 10)\r\n\r\n        # Classification results\r\n        self.results = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)\r\n        self.infoBox.pack_start(self.results, True, True, 0)\r\n        self.mainBox.pack_start(self.infoBox, True, True, 0)\r\n\r\n    def use_delegate(self):\r\n        return self.delegate_radio.get_active()\r\n\r\n    def on_radio_toggled(self, button):\r\n        if button.get_active():\r\n            print(f"Selected option: {button.get_label()}")\r\n\r\n    def process_file(self, filepath): \r\n        try:\r\n            # Resize Image\r\n            pixbuf = GdkPixbuf.Pixbuf.new_from_file(filepath)\r\n            new_width, new_height = resizeImage(pixbuf)\r\n            scaled_pixbuf = pixbuf.scale_simple(new_width, new_height, GdkPixbuf.InterpType.BILINEAR)\r\n            \r\n            # Replace the image with new image\r\n            self.image.set_from_pixbuf(scaled_pixbuf)\r\n           \r\n            # Run Inference\r\n            use_delegate = self.use_delegate()\r\n            print("delegate: " , use_delegate)\r\n            options, inference_time = runInference(filepath, use_delegate)\r\n\r\n            # Clear result box\r\n            for child in self.results.get_children():\r\n                self.results.remove(child)\r\n            \r\n            # Set up predictions\r\n            for label, percent in options:\r\n                textBox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)\r\n                barBox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)\r\n                text = Gtk.Label(label=label, xalign=0)\r\n                text.set_size_request(100, -1) \r\n                \r\n                bar = Gtk.ProgressBar()\r\n                bar.set_fraction(percent / 100.0)\r\n                bar.set_text(f"{percent:.2f}%")\r\n                bar.set_show_text(True)\r\n                \r\n                textBox.pack_start(text, False, False, 0)\r\n                barBox.pack_start(bar, True, True, 0)\r\n            \r\n                self.results.pack_start(textBox, False, False, 0)\r\n                self.results.pack_start(barBox, False, False, 0)\r\n                self.results.show_all()\r\n            \r\n            # Add inference time label\r\n            time_label = Gtk.Label(label=f"Inference Time : {inference_time * 1000:.2f} ms")\r\n            self.results.pack_start(time_label, False, False, 50)\r\n            self.results.show_all()\r\n        except Exception as e:\r\n            print("Error reading file:", e)\r\n\r\n    def on_open_file_clicked(self, widget):\r\n        dialog = FileBrowser()\r\n        selected_file = dialog.run_and_get_file()\r\n        self.imageFilepath = selected_file\r\n        if selected_file:\r\n            self.process_file(selected_file)\r\n \r\n    def on_reprocess_image_clicked(self, widget):\r\n        self.process_file(self.imageFilepath)\r\n\r\n    def on_destroy(self, widget):\r\n        Gtk.main_quit()\r\n\r\n# === Main Entry Point ===\r\ndef main():\r\n    app = MainWindow()\r\n    app.connect("destroy", Gtk.main_quit)\r\n    app.show_all()\r\n    Gtk.main()\r\n\r\nif __name__ == "__main__":\r\n    success, _ = Gtk.init_check()\r\n    if not success:\r\n        print("GTK could not be initialized. Check environmental variables")\r\n        exit(1)\r\n\r\n    main() \r\n\n'})}),(0,i.jsx)(n.p,{children:"Now you're set up to run the application on either CPU/delegate using the command below:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"python3 classification.py\n"})}),(0,i.jsx)(n.p,{children:"Select CPU as your runtime option on the GUI:"}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(48865).A+"",width:"4032",height:"3024"})}),(0,i.jsx)(n.p,{children:"Select delegate as your runtime option on the GUI:"}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(23662).A+"",width:"800",height:"600"})})]}),(0,i.jsxs)(o.A,{value:"Example3",label:"Object Detection",children:[(0,i.jsx)(n.h3,{id:"object-detection-with-opencv--wayland-display",children:"Object Detection with OpenCV & Wayland Display"}),(0,i.jsxs)(n.p,{children:["This Python script performs ",(0,i.jsx)(n.strong,{children:"real-time object detection"})," on a video file using a quantized ",(0,i.jsx)(n.strong,{children:"YOLOv8 TensorFlow Lite model"})," and displays the annotated frames via ",(0,i.jsx)(n.strong,{children:"GStreamer on a Wayland display"}),". It is optimized for ",(0,i.jsx)(n.strong,{children:"edge AI scenarios"})," using hardware acceleration through the ",(0,i.jsx)(n.strong,{children:"QNN TFLite delegate"}),"."]}),(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The YOLOv8 model isn't available by default. Please follow the ",(0,i.jsx)(n.strong,{children:"Step-6"})," from ",(0,i.jsx)(n.a,{href:"https://docs.qualcomm.com/bundle/publicresource/topics/80-70020-50/download-model-and-label-files.html?vproduct=1601111740013072&version=1.5&facet=Intelligent_Multimedia_SDK.SDK.2.0",children:(0,i.jsx)(n.strong,{children:"Qualcomm Intelligent Multimedia SDK"})})," to export YoloV8 quantized model."]})}),(0,i.jsx)(n.p,{children:"The next step is to push the model on to the target device\r\nThrough scp command copy the model onto the device."}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"scp xxxx.tflite ubuntu@IP_address:/home/ubuntu/\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Initialization and Configuration"}),(0,i.jsx)(n.br,{}),"\n","\u2022\tPaths for the model, labels, input video, and delegate are defined.",(0,i.jsx)(n.br,{}),"\n","\u2022\tConstants like frame dimensions, FPS, confidence threshold, and scaling factors are set for preprocessing and postprocessing."]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"MODEL_PATH"}),' = "yolov8_det_quantized.tflite"',(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.strong,{children:"LABEL_PATH"}),' = "coco_labels.txt"',(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.strong,{children:"VIDEO_IN"}),' = "video.mp4"',(0,i.jsx)(n.br,{}),"\n",(0,i.jsx)(n.strong,{children:"DELEGATE_PATH"}),' = "libQnnTFLiteDelegate.so"']}),(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.p,{children:["Use a video file that works well with object detection models.",(0,i.jsx)(n.br,{}),"\n","For best results, choose videos with clear subjects, good lighting, and minimal motion blur."]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Examples:"}),(0,i.jsx)(n.br,{}),"\n","\u2022 A street scene with vehicles and pedestrians",(0,i.jsx)(n.br,{}),"\n","\u2022 A warehouse or factory floor with visible objects",(0,i.jsx)(n.br,{}),"\n","\u2022 A static camera feed showing people or products"]})]}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Model Loading and Delegate Setup"}),(0,i.jsx)(n.br,{}),"\n","\u2022\tLoads the hardware delegate for accelerated inference.",(0,i.jsx)(n.br,{}),"\n","\u2022\tInitializes the TensorFlow Lite interpreter with the quantized YOLOv8 model."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"delegate_options = { 'backend_type': 'htp' }\r\ndelegate = tflite.load_delegate(DELEGATE_PATH, delegate_options)\r\ninterpreter = tflite.Interpreter(model_path=MODEL_PATH, experimental_delegates=[delegate])\r\ninterpreter.allocate_tensors()\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Label Loading"}),(0,i.jsx)(n.br,{}),"\n","\u2022\tLoads COCO dataset labels for object annotation."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"labels = [l.strip() for l in open(LABEL_PATH)]\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"GStreamer Pipeline Setup"}),(0,i.jsx)(n.br,{}),"\n","\u2022\tCreates a GStreamer pipeline using appsrc to stream frames to a Wayland sink.\r\n\u2022\tEnables real-time display of processed frames."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"pipeline = Gst.parse_launch(\r\n    'appsrc name=src is-live=true block=true format=time caps=video/x-raw,format=BGR,width=1600,height=900,framerate=30/1 ! videoconvert ! waylandsink')\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Video Capture and Frame Processing"}),(0,i.jsx)(n.br,{}),"\n","\u2022\tOpens the video file using OpenCV.",(0,i.jsx)(n.br,{}),"\n","\u2022\tEach frame is resized and preprocessed to match the model\u2019s input dimensions."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"cap = cv2.VideoCapture(VIDEO_IN)\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Inference and Post-processing"}),(0,i.jsx)(n.br,{}),"\n","\u2022\tRuns inference on each frame.",(0,i.jsx)(n.br,{}),"\n","\u2022\tDequantizes the model outputs using predefined scales and zero-points."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"interpreter.set_tensor(in_det[0]['index'], input_tensor)\r\ninterpreter.invoke()\r\nboxes_q = interpreter.get_tensor(out_det[0]['index'])[0]\r\nscores_q = interpreter.get_tensor(out_det[1]['index'])[0]\r\nclasses_q = interpreter.get_tensor(out_det[2]['index'])[0]\n"})}),(0,i.jsx)(n.p,{children:"\u2022\tApplies a confidence threshold to filter low-probability detections.\r\n\u2022\tUses Non-Maximum Suppression (NMS) to remove overlapping boxes."}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"mask = scores >= CONF_THRES\r\nboxes_f = boxes[mask]\r\nscores_f = scores[mask]\r\nclasses_f = classes[mask]\n"})}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Annotation and Display"})}),(0,i.jsx)(n.p,{children:"\u2022\tDraws bounding boxes and labels on the frame using OpenCV.\r\n\u2022\tLogs the highest detection score every 100 frames."}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'cv2.rectangle(frame_rs, (x1i, y1i), (x2i, y2i), (0,255,0), 2)\r\ncv2.putText(frame_rs, f"{lab} {sc:.2f}", (x1i, max(10,y1i-5)), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0,255,0), 2)\n'})}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Streaming to Wayland Display"})}),(0,i.jsx)(n.p,{children:"Converts frames to GStreamer buffers and pushes them to the pipeline with timestamps for smooth playback."}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"buf = Gst.Buffer.new_allocate(None, len(data), None)\r\nbuf.fill(0, data)\r\nbuf.duration = Gst.util_uint64_scale_int(1, Gst.SECOND, FPS_OUT)\r\ntimestamp = cap.get(cv2.CAP_PROP_POS_MSEC) * Gst.MSECOND\r\nbuf.pts = buf.dts = int(timestamp)\r\nappsrc.emit('push-buffer', buf)\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Completion"}),(0,i.jsx)(n.br,{}),"\n","Gracefully shuts down the pipeline after processing all frames."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"appsrc.emit('end-of-stream')\r\npipeline.set_state(Gst.State.NULL)\r\ncap.release()\n"})}),(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Use Cases"}),(0,i.jsx)(n.br,{}),"\n","This script is ideal for:",(0,i.jsx)(n.br,{}),"\n","\u2022\tSmart cameras",(0,i.jsx)(n.br,{}),"\n","\u2022\tRobotics",(0,i.jsx)(n.br,{}),"\n","\u2022\tEmbedded systems with Wayland-based GUIs",(0,i.jsx)(n.br,{}),"\n","\u2022\tReal-time monitoring in edge AI deployments"]}),(0,i.jsx)(n.h3,{id:"reference-code-1",children:"Reference Code"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"# -----------------------------------------------------------------------------\r\n#\r\n# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.\r\n# SPDX-License-Identifier: BSD-3-Clause\r\n#\r\n# -----------------------------------------------------------------------------\r\n\r\n#!/usr/bin/env python3\r\n\r\n# Import necessary libraries\r\nimport cv2\r\nimport numpy as np\r\nimport gi\r\ngi.require_version('Gst', '1.0')\r\nfrom gi.repository import Gst\r\nimport ai_edge_litert.interpreter as tflite\r\n\r\n# Initialize GStreamer\r\nGst.init(None)\r\n\r\n# -------------------- Parameters --------------------\r\nMODEL_PATH = \"/home/ubuntu/yolov8_det_quantized.tflite\"  # Path to TFLite model\r\nLABEL_PATH = \"/home/ubuntu/coco_labels.txt\"              # Path to label file\r\nVIDEO_IN = \"/etc/media/video.mp4\"                        # Input video file\r\nDELEGATE_PATH = \"libQnnTFLiteDelegate.so\"                # Delegate for hardware acceleration\r\n\r\n# Frame and model parameters\r\nFRAME_W, FRAME_H = 1600, 900\r\nFPS_OUT = 30\r\nCONF_THRES = 0.25\r\nNMS_IOU_THRES = 0.50\r\nBOX_SCALE = 3.2108588218688965\r\nBOX_ZP = 31.0\r\nSCORE_SCALE = 0.0038042240776121616\r\n# -------------------- Load Model --------------------\r\n# Load delegate for hardware acceleration\r\ndelegate_options = { 'backend_type': 'htp' }\r\ndelegate = tflite.load_delegate(DELEGATE_PATH, delegate_options)\r\n\r\n# Load and allocate TFLite interpreter\r\ninterpreter = tflite.Interpreter(model_path=MODEL_PATH, experimental_delegates=[delegate])\r\ninterpreter.allocate_tensors()\r\n\r\n# Get input/output tensor details\r\nin_det = interpreter.get_input_details()\r\nout_det = interpreter.get_output_details()\r\nin_h, in_w = in_det[0][\"shape\"][1:3]\r\n\r\n# -------------------- Load Labels --------------------\r\nlabels = [l.strip() for l in open(LABEL_PATH)]\r\n\r\n# -------------------- GStreamer Pipeline --------------------\r\n# Create GStreamer pipeline to display video via Wayland\r\npipeline = Gst.parse_launch(\r\n    'appsrc name=src is-live=true block=true format=time caps=video/x-raw,format=BGR,width=1600,height=900,framerate=30/1 ! videoconvert ! waylandsink'\r\n)\r\nappsrc = pipeline.get_by_name('src')\r\npipeline.set_state(Gst.State.PLAYING)\r\n\r\n# -------------------- Video Input --------------------\r\ncap = cv2.VideoCapture(VIDEO_IN)\r\n\r\n# Scaling factors for bounding box adjustment\r\nsx, sy = FRAME_W / in_w, FRAME_H / in_h\r\n\r\n# Preallocate frame buffers\r\nframe_rs = np.empty((FRAME_H, FRAME_W, 3), np.uint8)\r\ninput_tensor = np.empty((1, in_h, in_w, 3), np.uint8)\r\n\r\nframe_cnt = 0\r\n\r\n# -------------------- Main Loop --------------------\r\nwhile True:\r\n    ok, frame = cap.read()\r\n    if not ok:\r\n        break\r\n    frame_cnt += 1\r\n\r\n    # ---------- Preprocessing ----------\r\n    # Resize frame to display resolution\r\n    cv2.resize(frame, (FRAME_W, FRAME_H), dst=frame_rs)\r\n\r\n    # Resize again to model input resolution\r\n    cv2.resize(frame_rs, (in_w, in_h), dst=input_tensor[0])\r\n\r\n    # ---------- Inference ----------\r\n    # Set input tensor and run inference\r\n    interpreter.set_tensor(in_det[0]['index'], input_tensor)\r\n    interpreter.invoke()\r\n\r\n    # ---------- Postprocessing ----------\r\n    # Get raw output tensors\r\n    boxes_q = interpreter.get_tensor(out_det[0]['index'])[0]\r\n    scores_q = interpreter.get_tensor(out_det[1]['index'])[0]\r\n    classes_q = interpreter.get_tensor(out_det[2]['index'])[0]\r\n\r\n    # Dequantize outputs\r\n    boxes = BOX_SCALE * (boxes_q.astype(np.float32) - BOX_ZP)\r\n    scores = SCORE_SCALE * scores_q.astype(np.float32)\r\n    classes = classes_q.astype(np.int32)\r\n\r\n    # Filter by confidence threshold\r\n    mask = scores >= CONF_THRES\r\n    if np.any(mask):\r\n        boxes_f = boxes[mask]\r\n        scores_f = scores[mask]\r\n        classes_f = classes[mask]\r\n\r\n        # Convert boxes to OpenCV format\r\n        x1, y1, x2, y2 = boxes_f.T\r\n        boxes_cv2 = np.column_stack((x1, y1, x2 - x1, y2 - y1))\r\n\r\n        # Apply Non-Maximum Suppression\r\n        idx_cv2 = cv2.dnn.NMSBoxes(\r\n            bboxes=boxes_cv2.tolist(),\r\n            scores=scores_f.tolist(),\r\n            score_threshold=CONF_THRES,\r\n            nms_threshold=NMS_IOU_THRES\r\n        )\r\n\r\n        if len(idx_cv2):\r\n            idx = idx_cv2.flatten()\r\n            sel_boxes = boxes_f[idx]\r\n            sel_scores = scores_f[idx]\r\n            sel_classes = classes_f[idx]\r\n\r\n            # Debug print every 100 frames\r\n            if frame_cnt % 100 == 0:\r\n                print(f\"[{frame_cnt:4d}] max score = {sel_scores.max():.3f}\")\r\n\r\n            # Rescale boxes to display resolution\r\n            sel_boxes[:, [0,2]] *= sx\r\n            sel_boxes[:, [1,3]] *= sy\r\n            sel_boxes = sel_boxes.astype(np.int32)\r\n\r\n            # Clip boxes to frame boundaries\r\n            sel_boxes[:, [0,2]] = np.clip(sel_boxes[:, [0,2]], 0, FRAME_W-1)\r\n            sel_boxes[:, [1,3]] = np.clip(sel_boxes[:, [1,3]], 0, FRAME_H-1)\r\n\r\n            # Draw boxes and labels\r\n            for (x1i, y1i, x2i, y2i), sc, cl in zip(sel_boxes, sel_scores, sel_classes):\r\n                cv2.rectangle(frame_rs, (x1i, y1i), (x2i, y2i), (0,255,0), 2)\r\n                lab = labels[cl] if cl < len(labels) else str(cl)\r\n                cv2.putText(frame_rs, f\"{lab} {sc:.2f}\", (x1i, max(10,y1i-5)),\r\n                            cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0,255,0), 2)\r\n\r\n    # ---------- Video Output ----------\r\n    # Convert frame to bytes and push to GStreamer pipeline\r\n    data = frame_rs.tobytes()\r\n    buf = Gst.Buffer.new_allocate(None, len(data), None)\r\n    buf.fill(0, data)\r\n    buf.duration = Gst.util_uint64_scale_int(1, Gst.SECOND, FPS_OUT)\r\n    timestamp = cap.get(cv2.CAP_PROP_POS_MSEC) * Gst.MSECOND\r\n    buf.pts = buf.dts = int(timestamp)\r\n    appsrc.emit('push-buffer', buf)\r\n\r\n# -------------------- Finish --------------------\r\nappsrc.emit('end-of-stream')\r\npipeline.set_state(Gst.State.NULL)\r\ncap.release()\r\nprint(\"Done \u2013 video streamed to Wayland sink\")\n"})}),(0,i.jsx)(n.p,{children:"Now you're set up to run the application on NPU(delegate) using the command below:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"python3 ObjectDetection.py\n"})}),(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:t(34275).A+"",width:"975",height:"548"})})]})]})]})}function m(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}}}]);